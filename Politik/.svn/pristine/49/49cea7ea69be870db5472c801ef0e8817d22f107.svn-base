package com.saganet.politik.components.encuestas.sujetosSociales;

import java.util.HashMap;
import java.util.List;
import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;
import org.apache.ibatis.session.SqlSession;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.webflow.execution.RequestContext;

import com.saganet.politik.beans.seguridad.Usuario;
import com.saganet.politik.database.administracion.RolEO;
import com.saganet.politik.database.administracion.UsuarioEO;
//import com.saganet.politik.database.encuestas.edomex2017.EncuestaProsperaEO;
import com.saganet.politik.database.encuestas.edomex2017.callCenter.CapturistaEO;
import com.saganet.politik.database.encuestas.edomex2017.callCenter.EncargadoEO;
import com.saganet.politik.database.encuestas.edomex2017.supervisor.SupervisorEO;
import com.saganet.politik.database.encuestas.edomex2017.v2.EncuestaEO;
import com.saganet.politik.database.estructurasEdoMex.VisitadorEO;
import com.saganet.politik.dominios.GenerosDO;
import com.saganet.politik.modelos.Modelo;

@Component("sujetosSocialesCaptura")
public class CapturaC {
	@Autowired
	SqlSession sqlSession;
	private static final Logger logger = LoggerFactory.getLogger(CapturaC.class);

	public String buscarId(RequestContext context, Integer id) {
		HashMap<String, Object> mapa, parametros, viewScope;
		VisitadorEO encuestador;
		mapa = new HashMap<>();
		parametros = new HashMap<>();
		parametros.put("idInterno", id);
		encuestador = new VisitadorEO();
		viewScope = (HashMap<String, Object>) context.getFlowScope().asMap();
		boolean esSupervisor = false;
		boolean esCallCenter = false;
		boolean esEncuestador = false;
		boolean esCapturista = false;
		for (RolEO rol : getUsuario().getRoles()) {

			if (rol.getRol().equals("ROLE_ENCUESTAS_SUPERVISOR_EDOMEX")) {
				esSupervisor = true;
				break;
			} else if (rol.getRol().equals("ROLE_ENCUESTAS_EDOMEX_CALL_CENTER")) {
				esCallCenter = true;
				break;
			}else if(rol.getRol().equals("ROLE_ENCUESTA_EDOMEX")){
				esEncuestador = true;
			}else if(rol.getRol().equals("ROLE_ENCUESTAS_EDOMEX_CALL_CENTER_CAPTURISTA")){
				esCapturista = true;
			}
		}

		// buscamos los datos
		if (esSupervisor) {
			SupervisorEO supervisor;
			supervisor = sqlSession.selectOne("encuestas.supervisor.supervisor.buscarPorId", getUsuario().getNick());
			parametros.put("programa", supervisor.getProgama());
			parametros.put("tipo", "SUPERVISOR");
		} else if (esCallCenter) {
			logger.debug("Call Center: {} ");
			EncargadoEO encargado;
			encargado = new EncargadoEO();
			encargado = sqlSession.selectOne("encuestas.callcenter.encargado.buscarPorNick", getUsuario().getNick());
			parametros.put("programa", encargado.getProgama());
			parametros.put("tipo", "CALL_CENTER");
		} else{
			
			encuestador = sqlSession.selectOne("estructurasEdoMex.visitador.buscarPorNick",getUsuario().getNick());
			logger.debug("Visitador: {}", encuestador);
			if(encuestador!=null){
				parametros.put("tipo", "ENCUESTADOR");
			logger.debug("Encuestador: {}", encuestador);
			parametros.put("programa", encuestador.getPrograma());
				if( encuestador.getMunicipio()==null){
					parametros.put("municipio", 9999999);
				}else{
				parametros.put("municipio", encuestador.getMunicipio().getIdMunicipio());
				}
			}
			CapturistaEO capturista;
			capturista = sqlSession.selectOne("encuestas.edomex2017.callcenter.capturista.buscarPorNick", getUsuario().getNick());
			logger.debug("Capturista: {}", capturista);
			if(capturista!=null){
				parametros.put("tipo", "CAPTURISTA");
				logger.debug("CAPTURISTA: {}", capturista);
				parametros.put("programa", capturista.getEncargado().getProgama());
				
				}
		}
		// fin

		mapa = new HashMap<>();
		logger.debug("Programa: {}", encuestador.getPrograma().toString());
		parametros.put("programa", encuestador.getPrograma().toString());
		logger.debug("Antes de mapa: {}", parametros);
		mapa = sqlSession.selectOne("encuestas.sujetosSociales.captura.buscarPorId", parametros);
		logger.debug("despues de mapa: {}", mapa);
		if (mapa != null) {
			viewScope.put("contacto", mapa);
			viewScope.put("parametros", parametros);
			logger.debug("succes: {}", viewScope);
			//if(mapa.get("estatus").equals("PENDIENTE")){
				return "success";
			//}else{
			//	FacesContext.getCurrentInstance().addMessage(null,
				//		new FacesMessage(FacesMessage.SEVERITY_WARN, "El folio consultado ya ha sido capturado anteriormente", "Contact admin."));
			//	return "error";
			//}
			
		} else {
			FacesContext.getCurrentInstance().addMessage(null,
					new FacesMessage(FacesMessage.SEVERITY_ERROR, "No se encontró información", "Contact admin."));
			return "error";
		}
	}

	public EncuestaEO nuevo(HashMap<String, Object> contacto, String estatus) {
		logger.debug("Estatus: {}", estatus);
		logger.debug("Folio: {}", contacto.get("id_interno"));
		EncuestaEO nuevo, consulta;

		nuevo = new EncuestaEO();
		consulta = new EncuestaEO();
		if (!estatus.equals("PENDIENTE")) {
			consulta = sqlSession.selectOne("encuestas.sujetosSociales.captura.buscarEncuesta", contacto.get("id_interno").toString());
			logger.debug("Consulta: {}", consulta);
			nuevo.setId(consulta.getId());
			nuevo.setR1(consulta.getR1());
			nuevo.setR2(consulta.getR2());
			nuevo.setR3(consulta.getR3());
			nuevo.setR4(consulta.getR4());
			nuevo.setResultado(consulta.getResultado());
			nuevo.setIdContacto(Integer.parseInt(consulta.getIdContacto().toString()));
			nuevo.setNick(consulta.getNick());
			nuevo.setNombre(consulta.getNombre());
			nuevo.setPaterno(consulta.getPaterno());
			nuevo.setMaterno(consulta.getMaterno());
			nuevo.setFechaNacimiento(consulta.getFechaNacimiento());
			nuevo.setGenero(consulta.getGenero());
			nuevo.setEncuestador(consulta.getEncuestador());
			nuevo.setTel(consulta.getTel());
			nuevo.setEmail(consulta.getEmail());
			logger.debug("Nuevo: {}", nuevo);
		} else {
			nuevo = new EncuestaEO();
			nuevo.setIdContacto(Integer.parseInt(contacto.get("id_interno").toString()));
			nuevo.setNick(getUsuario().getNick());
			nuevo.setNombre(contacto.get("nombre").toString());
			nuevo.setPaterno(contacto.get("apellido_paterno").toString());
			nuevo.setMaterno(contacto.get("apellido_materno").toString());
			nuevo.setFechaNacimiento(contacto.get("fecha_nacimiento").toString().substring(6,8)+"/"+contacto.get("fecha_nacimiento").toString().substring(4,6) + "/"+contacto.get("fecha_nacimiento").toString().substring(0,5));
			nuevo.setGenero(contacto.get("sexo").toString().equals("H")?GenerosDO.H:GenerosDO.M);
		}
		return nuevo;
	}
	


	public void guardar(EncuestaEO encuesta) {
		logger.debug("Encuesta guardar: {}", encuesta);
		sqlSession.insert("encuestas.sujetosSociales.captura.insertar", encuesta);
		sqlSession.update("encuestas.sujetosSociales.captura.actualizarEstatus", encuesta);
	}


	public void actualizar(EncuestaEO encuesta) {
		logger.debug("encuesta: {}", encuesta);
		sqlSession.update("encuestas.sujetosSociales.captura.actualizarEncuesta", encuesta);
		sqlSession.update("encuestas.sujetosSociales.captura.actualizarEstatus", encuesta);
	}


	public Modelo<VisitadorEO> encuestadores() {
		Modelo<VisitadorEO> modelo;
		List<VisitadorEO> listado;

		boolean esSupervisor = false;
		boolean esCallCenter = false;
		boolean esEncuestador = false;
		boolean esCapturista = false;
		for (RolEO rol : getUsuario().getRoles()) {

			if (rol.getRol().equals("ROLE_ENCUESTAS_SUPERVISOR_EDOMEX")) {
				esSupervisor = true;
				break;
			} else if (rol.getRol().equals("ROLE_ENCUESTAS_EDOMEX_CALL_CENTER")) {
				esCallCenter = true;
				break;
			}else if(rol.getRol().equals("ROLE_ENCUESTA_EDOMEX")){
				esEncuestador = true;
			}else if(rol.getRol().equals("ROLE_ENCUESTAS_EDOMEX_CALL_CENTER_CAPTURISTA")){
				esCapturista = true;
			}
		}
		if (esSupervisor) {
			listado = sqlSession.selectList("encuestas.supervisor.encuestador.buscarPorSupervisor",getUsuario().getNick());
		} else if (esCallCenter) {
			EncargadoEO encargado;
			encargado = new EncargadoEO();
			encargado = sqlSession.selectOne("encuestas.callcenter.encargado.buscarPorNick", getUsuario().getNick());
			listado = sqlSession.selectList("encuestas.supervisor.encuestador.buscarPorEncargadoCallCenter",encargado.getUsuario().getNick());
		}else if(esCapturista){
		
			CapturistaEO capturista;
			capturista = new CapturistaEO();
			capturista = sqlSession.selectOne("encuestas.edomex2017.callcenter.capturista.buscarPorNick", getUsuario().getNick());
			
			listado = sqlSession.selectList("encuestas.supervisor.encuestador.buscarPorEncargadoCallCenter",capturista.getEncargado().getUsuario().getNick());
		}else {

			listado = sqlSession.selectList("estructurasEdoMex.visitador.buscarPorNick", getUsuario().getNick());
		}
		modelo = new Modelo<>(listado);
		return modelo;

	}

	public UsuarioEO getUsuario() {
		return ((Usuario) SecurityContextHolder.getContext().getAuthentication().getPrincipal()).getUsuario();
	}

}
