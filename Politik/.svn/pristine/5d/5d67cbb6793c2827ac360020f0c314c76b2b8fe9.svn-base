<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="administracion.usuarios">
	<cache />
	
	<resultMap type="UsuarioEO" id="usuario">
		<id column="UsuarioEO_id" property="id" javaType="Integer"/>
		<result column="UsuarioEO_nick" property="nick" javaType="String"/>
		<result column="UsuarioEO_nombre" property="nombre" javaType="String"/>
		<result column="UsuarioEO_pw" property="pw" javaType="String"/>
		<result column="UsuarioEO_habilitado" property="habilitado" javaType="Boolean"/>
		<result column="UsuarioEO_nivel" property="nivel" javaType="com.saganet.politik.dominios.NivelesDO"/>
		<association property="roles" resultMap="administracion.roles.rol" />
	</resultMap>
	
	<sql id="query">
		SELECT
			UsuarioEO.pkey 			UsuarioEO_id, 
			UsuarioEO.nick 			UsuarioEO_nick, 
			UsuarioEO.nombre 		UsuarioEO_nombre,
			UsuarioEO.pw 			UsuarioEO_pw,
			UsuarioEO.nivel			UsuarioEO_nivel,
			UsuarioEO.habilitado 	UsuarioEO_habilitado,
			RolEO.pkey 				RolEO_id, 
			RolEO.rol 				RolEO_rol,
			RolEO.descripcion 		RolEO_descripcion 
  		FROM administracion.usuarios UsuarioEO
  		JOIN administracion.autorizaciones adminAutorizaciones ON (UsuarioEO.nick = adminAutorizaciones.nick)
  		JOIN administracion.roles RolEO ON (adminAutorizaciones.rol = RolEO.rol)
	</sql>
	
	<select id="listado" resultMap="usuario">
		<include refid="query" />
		ORDER BY UsuarioEO.nick
	</select>
	
	<select id="porNick" resultMap="usuario">
		<include refid="query" />
		WHERE UsuarioEO.nick = #{nick}
	</select>
	
	<insert id="insertar" parameterType="UsuarioEO">
		<selectKey keyProperty="id" order="BEFORE" resultType="Integer">
			SELECT nextval('administracion.usuarios_pkey_seq'::regclass)
		</selectKey>
		INSERT INTO administracion.usuarios(nick, pw, habilitado, nombre, pkey, nivel)
    	VALUES (#{nick}, crypt(#{pw}, gen_salt('bf', 8)), #{habilitado}, #{nombre}, #{id}, #{nivel});
	</insert>
	
	<insert id="insertarTerritorios" parameterType="UsuarioEO">
		<if test="nivel.name() != 'NACIONAL'">
			INSERT INTO administracion.usuarios_llaves(nick, llave)
	        VALUES
	        <foreach collection="territorios" item="item" separator="," close=";">
				(#{nick}, #{item.llave})
			</foreach>		
		</if>
	</insert>
	
	<update id="actualizar" parameterType="UsuarioEO">
		UPDATE administracion.usuarios
		SET 
		<if test="pw != ''">
			pw = crypt(#{pw}, gen_salt('bf', 8)),
		</if>
			habilitado = #{habilitado}, 
			nombre = #{nombre},
			nivel = #{nivel}
   		WHERE nick = #{nick}
	</update>
	
	<delete id="eliminarTerritoriosPorUsuario" parameterType="UsuarioEO">
		DELETE FROM administracion.usuarios_llaves
		WHERE nick = #{nick}
	</delete>
</mapper>
